<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG Chat Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-100">
  <div class="mx-auto max-w-4xl h-screen flex flex-col">
    <!-- Header -->
    <header class="px-5 py-4 border-b border-white/10 flex items-baseline justify-between">
      <div>
        <div class="text-lg font-semibold">RAG Chat Demo</div>
        <div class="text-sm text-slate-300/80">Streaming via Server-Sent Events (SSE)</div>
      </div>
      <div class="text-sm text-slate-300/80">
        Conversation: <span id="conv" class="font-mono"></span>
      </div>
    </header>

    <!-- Chat -->
    <main id="chat" class="flex-1 overflow-auto px-5 py-5 space-y-3"></main>

    <!-- Composer -->
    <footer class="px-5 py-4 border-t border-white/10 flex gap-3">
      <input
        id="prompt"
        class="flex-1 rounded-xl border border-white/10 bg-white/5 px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500/60"
        placeholder="Ask somethingâ€¦"
        autocomplete="off"
      />
      <button
        id="send"
        class="rounded-xl border border-white/10 bg-indigo-500/20 px-4 py-3 hover:bg-indigo-500/30 disabled:opacity-60"
      >
        Send
      </button>
    </footer>
  </div>

<script>
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("prompt");
  const sendBtn = document.getElementById("send");
  const convEl = document.getElementById("conv");

  const conversationId = localStorage.getItem("conversationId") || crypto.randomUUID();
  localStorage.setItem("conversationId", conversationId);
  convEl.textContent = conversationId.slice(0, 8);

  function scrollToBottom() { chatEl.scrollTop = chatEl.scrollHeight; }

  function bubble(role, text) {
    const outer = document.createElement("div");
    outer.className = `flex ${role === "user" ? "justify-end" : "justify-start"}`;

    const inner = document.createElement("div");
    inner.className =
      role === "user"
        ? "max-w-[80%] whitespace-pre-wrap rounded-2xl border border-indigo-400/20 bg-indigo-500/15 px-4 py-3 leading-relaxed"
        : "max-w-[80%] whitespace-pre-wrap rounded-2xl border border-white/10 bg-white/5 px-4 py-3 leading-relaxed";

    inner.textContent = text;

    outer.appendChild(inner);
    chatEl.appendChild(outer);
    scrollToBottom();
    return inner;
  }

  function addSources(botInner, sources) {
    if (!Array.isArray(sources) || sources.length === 0) return;

    const answerOuter = botInner.parentElement ?? chatEl;

    const outer = document.createElement("div");
    outer.className = "flex justify-start";

    const inner = document.createElement("div");
    inner.className =
      "mt-2 max-w-[80%] rounded-2xl border border-emerald-400/25 bg-emerald-500/10 px-4 py-3 text-sm leading-relaxed shadow-lg shadow-emerald-900/40";

    const title = document.createElement("div");
    title.className = "text-xs uppercase tracking-wide text-emerald-200/90";
    title.textContent = "Sources";
    inner.appendChild(title);

    const list = document.createElement("div");
    list.className = "mt-2 flex flex-wrap gap-2";

    sources.forEach((s, idx) => {
      const link = document.createElement("a");
      const href = s.url || "#";
      link.href = href;
      link.target = "_blank";
      link.rel = "noreferrer noopener";
      link.className =
        "inline-flex min-w-[140px] flex-col gap-1 rounded-xl border border-emerald-400/30 bg-black/30 px-3 py-2 text-emerald-50 transition hover:border-emerald-200 hover:bg-emerald-400/10";

      const titleText = s.url;
      const titleEl = document.createElement("div");
      titleEl.className = "font-medium";
      titleEl.textContent = titleText;
      link.appendChild(titleEl);

      list.appendChild(link);
    });

    inner.appendChild(list);
    outer.appendChild(inner);

    answerOuter.insertAdjacentElement("afterend", outer);
    scrollToBottom();
  }

  async function send() {
    const message = inputEl.value.trim();
    if (!message) return;

    inputEl.value = "";
    inputEl.focus();

    bubble("user", message);
    const botInner = bubble("bot", "");

    sendBtn.disabled = true;
    inputEl.disabled = true;

    const url = `/api/v1/chat/stream?conversationId=${encodeURIComponent(conversationId)}&message=${encodeURIComponent(message)}`;
    const es = new EventSource(url);

    es.addEventListener("message", (ev) => {
      botInner.textContent += ev.data;
      scrollToBottom();
    });

    es.addEventListener("sources", (ev) => {
      try {
        addSources(botInner, JSON.parse(ev.data));
      } catch (e) {
        console.warn("Failed to parse sources", e);
      }
    });

    es.addEventListener("done", () => {
      es.close();
      sendBtn.disabled = false;
      inputEl.disabled = false;
      inputEl.focus();
    });

    es.addEventListener("error", () => {
      es.close();
      botInner.textContent += "\n\n[stream error]";
      sendBtn.disabled = false;
      inputEl.disabled = false;
      inputEl.focus();
    });
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });
</script>
</body>
</html>
